---
title: "Analyzing the FDA_NDC_Product Dataset"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(reshape2)
```

##Addressing Issue #70 Questions

Read in the FDA_NDC data and Medicare spending data...
```{r}
ndc.dat <- read.csv('fda_ndc_product.csv')
spd.dat <- read.csv('spending_2011.csv')
````

What's in there?
```{r}
print('FDA_NDC names:')
names(ndc.dat)
print('')
print('spending_2011 names:')
names(spd.dat)
````


###Preliminaries
Every entry in the original dataset corresponded to a unique **productid**...
```{r}
length( unique(ndc.dat$productid) )
````

...and there are a couple fewer **productndcs**.  It seems like the **productid** would be the best way through which to cross-reference the datasets.
```{r}
length( unique(ndc.dat$productndc) )
length( unique(ndc.dat$productid) ) - length( unique(ndc.dat$productndc) )
````

For reference there are far fewer **nonproprietarynames** and **substancenames** than **productids**
```{r}
length( unique(ndc.dat$nonproprietaryname) )
length( unique(ndc.dat$substancename) )
````

###How many drugs have multiple active ingredients?
Let's see how many drugs have more than one active ingredient:
```{r}
pid.agg.ndc <- dcast(ndc.dat, productid ~ .)
names( pid.agg.ndc ) <- c('productid', 'occurences')
print('About 26.5k:')
length( pid.agg.ndc[ pid.agg.ndc$occurences > 1, 1] )
````

###How many (total) of the drugs can be matched between the Medicare spending datasets and the FDA_NDC_Product dataset?
The spending dataset needs to be converted to lowercase for a few columns, in order to match with the FDA_NDC data.  To do this I'm going to wrap the tolower() function in an error catcher, as this was used to lowercase the FDA_NDC dataset during tidying and things won't get derailed by weird cornercases.
```{r}
safe.lower <- function(x){
    result <- tryCatch({
        sapply( x, tolower)
    },
    error = function(e){
        return( as.character(x) )
    })
    return( result )
    }

upper.cols <- c('drugname_brand', 'drugname_generic')
spd.dat[, upper.cols] <- sapply( spd.dat[, upper.cols], safe.lower )

head(spd.dat)
````

How many matches are there between speeding_2011 and FDA_NDC?
```{r}
sum( spd.dat$drugname_brand %in% ndc.dat$proprietaryname)
````


###How many of the drugs found in the Medicare spending datasets have multiple active ingredients?
Let's match the **proprietaryname** column to the **drugname_brand** column.  If there are any matches I'm going to pull the corresponding **productids** and hold them in a vector.
```{r}
match.ids <- ndc.dat[ ndc.dat$proprietaryname %in% spd.dat$drugname_brand, c('productid') ]
match.ids <- as.character( match.ids )
length(match.ids)
````

How many unique match ids are there?
```{r}
length(unique(match.ids))
````

Since there are about 32.5k total **match.ids** and 29.5k unique **match.ids** then there are around 3k spending_2011 **drugname_brands** that have multiple active ingredients.
```{r}
length(match.ids) - length(unique(match.ids))
````

How well does **drugname_generic** match against the **nonproprietaryname** column?  There 1741 of the generic drugnames in the **nonproprietaryname** column, and almost as many in the **substancename** column.  A pretty good amount of those are associated with a **drugname_brand** that also matches in the **proprietaryname** column.
```{r}
#Number of drugname_generics that match in nonproprietaryname
sum(spd.dat$drugname_generic %in% ndc.dat$nonproprietaryname)

#Number of drugname_generics that match in substancename
sum(spd.dat$drugname_generic %in% ndc.dat$substancename)

#Number of drugname_brands that match in proprietaryname that also share a row with a drugname_generic that matches a nonproprietaryname
sum(spd.dat[ spd.dat$drugname_brand %in% ndc.dat$proprietaryname, c('drugname_generic') ] %in% ndc.dat$nonproprietaryname )

#Number of drugname_brands that match in proprietaryname that also share a row with a drugname_generic that matches a substancename
sum(spd.dat[ spd.dat$drugname_brand %in% ndc.dat$proprietaryname, c('drugname_generic') ] %in% ndc.dat$substancename )
````

I'm going to create a subvector of **match.ids** which contains only ids that occur more than once, to see if the spending data **drugname_generic** also contains multiple names.
```{r}
id.occs <- as.data.frame( table( match.ids ) )
mult.act.ingd <- id.occs[ id.occs$Freq > 1, ]$match.ids
````
  
(IN PROGRESS)