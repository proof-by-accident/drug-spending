---
title: "Analyzing the FDA_NDC_Product Dataset"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(reshape2)
library(plyr)
library(data.world)
```

##Addressing Issue #70 Questions

Read in the FDA_NDC data and Medicare spending data...
```{r}
ds <- 'https://data.world/data4democracy/drug-spending'
ndc.dat <- data.world::query( data.world::qry_sql( 'SELECT proprietaryname, nonproprietaryname, substancename, productid FROM fda_ndc_product_tidy' ) , dataset=ds )
spd.dat <- data.world::query( data.world::qry_sql( 'SELECT brand_name, generic_name FROM spending_part_d_2011to2015_tidy' ) , dataset=ds )

````


###How many drugs have multiple active ingredients?
Let's see how many drugs total in the `fda_ndc_product_tidy` have more than one active ingredient:
```{r}
pid.agg.ndc <- dcast(ndc.dat, productid ~ .)
names( pid.agg.ndc ) <- c('productid', 'occurences')
print('About 26.5k:')
length( pid.agg.ndc[ pid.agg.ndc$occurences > 1, 1] )
````

```{r}
pid.agg.ndc <- dcast(ndc.dat, proprietaryname ~ .)
names( pid.agg.ndc ) <- c('propname', 'occurences')
print('About 26.5k:')
length( pid.agg.ndc[ pid.agg.ndc$occurences > 1, 1] )
````

How about drugs that match the `spending_201x` dataset?
```{r}
pid.agg

````

###How many total of the drugs can be matched between the Medicare spending datasets and the FDA_NDC_Product dataset?
Joining the spending and FDA_NDC datasets `join()` matches two columns with the same name in different dataframes, so we need to first renamed `drugname_brand` to `proprietaryname` in `spd.dat`.
```{r}
names(spd.dat)[2] <- 'proprietaryname'
ndc.spd.join <- join(spd.dat, ndc.dat, type="inner", by=c('proprietaryname'))
dim(ndc.spd.join)
````

What's the relationship between `drugname_generic` and `nonproprietaryname` and also `substancename`?
```{r}
sum( ndc.spd.join$drugname_generic == ndc.spd.join$nonproprietaryname )
sum( ndc.spd.join$drugname_generic[ !is.na(ndc.spd.join$substancename) ] == ndc.spd.join$substancename[ !is.na(ndc.spd.join$substancename) ] )
`````

It looks like there's a good number of matches between the two.