---
title: "Analyzing the FDA_NDC_Product Dataset"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(reshape2)
```

## Tidying
Let's read in our data...
```{r}
ndc.dat <- read.csv('fda_ndc_product.csv')
spd.dat <- read.csv('spending_2011.csv')
````

What's in there?
```{r}
names(ndc.dat)
````

##Preliminary Exploration
###How many drugs have multiple active ingredients?
Every entry in the original dataset corresponded to a unique **productid**...
```{r}
length( unique(ndc.dat$productid) )
````

...and there are a couple fewer **productndcs**.  It seems like the **productid** would be the best way through which to cross-reference the datasets.
```{r}
length( unique(ndc.dat$productndc) )
length( unique(ndc.dat$productid) ) - length( unique(ndc.dat$productndc) )
````

There are far fewer **nonproprietarynames** and **substancenames**.
```{r}
length( unique(ndc.dat$nonproprietaryname) )
length( unique(ndc.dat$substancename) )
````

Let's see how many drugs have more than one active ingredient:
```{r}
pid.agg.ndc <- dcast(ndc.dat, productid ~ .)
names( pid.agg.ndc ) <- c('productid', 'occurences')
#About 26k:
length( pid.agg.ndc[ pid.agg.ndc$occurences > 1, 1] )
````

###Comparing to the spending_2011 dataset
The spending dataset needs to be converted to lowercase for a few columns.  To do this I'm going to wrap the tolower() function in an error catcher, as this was used to lowercase the FDA_NDC dataset as well and things won't get derailed by weird cornercases.
```{r}
safe.lower <- function(x){
    result <- tryCatch({
        sapply( x, tolower)
    },
    error = function(e){
        return( as.character(x) )
    })
    return( result )
    }

upper.cols <- c('drugname_brand', 'drugname_generic')
spd.dat[, upper.cols] <- sapply( spd.dat[, upper.cols], safe.lower )

head(spd.dat)
````

How many matches are there between speding_2011 and FDA_NDC?
```{r}
sum( spd.dat$drugname_brand %in% ndc.dat$proprietaryname)
````

Let's match the **proprietaryname** column to the **drugname_brand** column.  If there are any matches I'm going to pull the corresponding **productids** and hold them in a vector.
```{r}
match.ids <- ndc.dat[ ndc.dat$proprietaryname %in% spd.dat$drugname_brand, c('productid') ]
length(match.ids)
````

How well does **drugname_generic** match against the **nonproprietaryname** column?  There 1741 of the generic drugnames in the **nonproprietaryname** column, and almost as many in the **substancename** column.  A pretty good amount of those are associated with a **drugname_brand** which is in the **proprietaryname** column.
```{r}
sum(spd.dat$drugname_generic %in% ndc.dat$nonproprietaryname)
sum(spd.dat$drugname_generic %in% ndc.dat$substancename)
sum(spd.dat[ spd.dat$drugname_brand %in% ndc.dat$proprietaryname, c('drugname_generic') ] %in% ndc.dat$nonproprietaryname )
sum(spd.dat[ spd.dat$drugname_brand %in% ndc.dat$proprietaryname, c('drugname_generic') ] %in% ndc.dat$substancename )
````


  